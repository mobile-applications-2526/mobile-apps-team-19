version: "3.8"

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      # Use 'local' for H2 in-memory (no DB needed), 'prod' for Supabase
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-local}

      # Only set database vars if using prod profile
      # For local profile, these are ignored and H2 is used instead
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=${SPRING_DATASOURCE_DRIVER_CLASS_NAME:-}

      # Supabase configuration (prod only)
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY:-}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY:-}

      # CORS & JWT
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:8081}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-here-make-it-at-least-32-characters-long}

      # Java memory settings
      - JAVA_OPTS=${JAVA_OPTS:--Xms256m -Xmx512m}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
